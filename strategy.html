<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iron Dominion: World Strategy</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #ffd700;
            --accent-color: #ff9933;
            --border-color: #8b7355;
            --panel-bg: rgba(20, 20, 20, 0.95);
            --topbar-bg: rgba(10, 10, 10, 0.95);
            --success: #44ff44;
            --danger: #ff4444;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', monospace;
            overflow: hidden;
            user-select: none;
        }

        #game-container {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100vh;
        }

        /* --- TOP BAR (HOI4 Style) --- */
        #top-bar {
            height: 50px;
            background: var(--topbar-bg);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .top-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-box {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            background: rgba(255,255,255,0.05);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #333;
        }

        .stat-icon { font-size: 1.2em; }

        #country-selector {
            background: #222;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px;
            font-family: inherit;
            font-weight: bold;
        }

        /* --- MAP AREA --- */
        #map-area {
            flex-grow: 1;
            position: relative;
            background: #050505;
            overflow: hidden;
            cursor: grab;
        }

        #map-area:active {
            cursor: grabbing;
        }

        canvas {
            display: block;
        }

        /* --- PROVINCE PANEL (Bottom Left) --- */
        #province-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 300px;
            background: var(--panel-bg);
            border: 2px solid var(--border-color);
            padding: 15px;
            display: none; /* Hidden by default */
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            z-index: 90;
        }

        .panel-header {
            color: var(--accent-color);
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        /* --- LOG PANEL (Bottom Right) --- */
        #log-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 150px;
            background: rgba(0,0,0,0.6);
            border: 1px solid #333;
            padding: 10px;
            overflow-y: auto;
            font-size: 0.8em;
            color: #aaa;
            pointer-events: none; /* Let clicks pass through if needed, but scroll might need events */
            pointer-events: auto;
        }

        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-entry.war { color: #ff4444; }
        .log-entry.peace { color: #44ff44; }
        .log-entry.info { color: #88ccff; }

        /* --- BUTTONS --- */
        .btn {
            background: #333;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 6px 10px;
            cursor: pointer;
            text-transform: uppercase;
            font-family: inherit;
            font-weight: bold;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        .btn:hover { background: var(--accent-color); color: #000; }
        .btn-block { width: 100%; margin-bottom: 5px; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: #000; }

        /* --- MODALS --- */
        .modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: var(--panel-bg);
            border: 2px solid var(--accent-color);
            padding: 30px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 153, 51, 0.2);
        }

        h1 { margin: 0 0 20px 0; color: var(--accent-color); }
        h2 { margin: 0 0 15px 0; color: #fff; font-size: 1.2em; }
        p { line-height: 1.5; color: #ccc; margin-bottom: 20px; }
        
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--accent-color);
            padding: 8px;
            pointer-events: none;
            display: none;
            z-index: 200;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<div id="game-container">
    <!-- TOP BAR -->
    <div id="top-bar">
        <div class="top-section">
            <div style="font-weight: bold; color: var(--accent-color); margin-right: 15px;">IRON DOMINION</div>
            <div id="player-country-display" style="font-weight: bold; color: #fff; border: 1px solid #444; padding: 5px 10px; background: #222;">-</div>
        </div>

        <div class="top-section stats">
            <div class="stat-box" title="Manpower"><span class="stat-icon">üë•</span> <span id="player-manpower">0</span></div>
            <div class="stat-box" title="Industry"><span class="stat-icon">üè≠</span> <span id="player-industry">0</span></div>
            <div class="stat-box" title="Territory"><span class="stat-icon">üö©</span> <span id="player-provinces">0</span></div>
        </div>

        <div class="top-section">
            <div style="margin-right: 15px; color: #aaa;">DAY <span id="game-day" style="color: #fff; font-weight: bold;">1</span></div>
            <button class="btn" onclick="game.togglePause()" id="btn-pause">‚è∏</button>
            <button class="btn" onclick="window.location.href='index.html'" style="margin-left: 10px;">EXIT</button>
        </div>
    </div>

    <!-- MAP AREA -->
    <div id="map-area">
        <canvas id="gameCanvas"></canvas>
        <div id="tooltip"></div>

        <!-- PROVINCE PANEL -->
        <div id="province-panel">
            <div class="panel-header">
                <span id="prov-name">Province</span>
                <span id="prov-id" style="font-size: 0.7em; color: #666;">#000</span>
            </div>
            
            <div style="margin-bottom: 15px;">
                <div class="stat-row"><span>Owner:</span> <span id="prov-owner">-</span></div>
                <div class="stat-row"><span>Garrison:</span> <span id="prov-army" style="color: #aaa;">0</span></div>
                <div class="stat-row"><span>Fortification:</span> <span id="prov-defense" style="color: #aaa;">0%</span></div>
            </div>

            <div id="owner-actions">
                <button class="btn btn-block" onclick="game.actions.recruit()">Recruit (+50 Army) <span style="float:right; color:#888">100MP</span></button>
                <button class="btn btn-block" onclick="game.actions.build('factory')">Build Factory <span style="float:right; color:#888">500MP</span></button>
                <button class="btn btn-block" onclick="game.actions.build('fort')">Build Fort <span style="float:right; color:#888">300MP</span></button>
                <button class="btn btn-block btn-danger" onclick="game.actions.attackMode()">‚öî LAUNCH ASSAULT</button>
            </div>
            
            <div id="admin-actions" style="margin-top: 10px; border-top: 1px solid #333; padding-top: 10px;">
                <button class="btn btn-block" style="background: #442222;" onclick="game.actions.cheatAnnex()">‚ö† FORCE ANNEX</button>
            </div>
        </div>

        <!-- LOG PANEL -->
        <div id="log-panel">
            <div style="color: #666; font-size: 0.9em; border-bottom: 1px solid #333; margin-bottom: 5px;">COMMUNICATIONS LOG</div>
            <div id="log-content"></div>
        </div>
    </div>
</div>

<!-- SETUP MODAL -->
<div id="setup-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <h1>SELECT YOUR NATION</h1>
        <p>Choose a superpower to lead into the new world order.</p>
        
        <div id="country-selection-list" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 30px;">
            <!-- Populated by JS -->
        </div>

        <div style="text-align: left; margin: 20px 0; background: rgba(0,0,0,0.3); padding: 15px;">
            <h2>BRIEFING</h2>
            <p><strong>DRAG</strong> to pan the map view.</p>
            <p><strong>CLICK</strong> on a province to select it.</p>
            <p><strong>MANAGE</strong> your economy and army using the bottom-left panel.</p>
            <p><strong>ATTACK</strong> neighbors by selecting your province, clicking "Launch Assault", then clicking a target.</p>
        </div>
    </div>
</div>

<!-- GAME OVER MODAL -->
<div id="overlay" class="modal" style="display: none;">
    <div class="modal-content">
        <h1 id="overlay-title">CAMPAIGN ENDED</h1>
        <p id="overlay-msg">The world has been unified.</p>
        <button class="btn" style="padding: 15px 40px;" onclick="location.reload()">RESTART WORLD</button>
    </div>
</div>

<script>
/**
 * IRON DOMINION - World Strategy Engine [R30]
 */

const CONFIG = {
    hexSize: 20,
    tickRate: 800,
    colors: {
        water: '#080808',
        neutral: '#2a2a2a',
        highlight: 'rgba(255, 255, 255, 0.15)',
        selected: 'rgba(255, 215, 0, 0.5)',
        border: '#000'
    }
};

// --- WORLD DATA ---
const ASCII_WORLD = [
    "................................................................................",
    "................................................................................",
    "..........NNNNNN................................................................",
    "........NNNNNNNNNN..............................................................",
    ".......NNNNNNNNNNNN...........................EEEEEEEEEE.......RRRRRRRRRRRR.....",
    "......NNNNNNNNNNNNNN........................EEEEEEEEEEEEEE...RRRRRRRRRRRRRRRR...",
    "......NNNNNNNNNNNNNN.......................EEEEEEEEEEEEEEEE.RRRRRRRRRRRRRRRRRR..",
    ".......NNNNNNNNNNNN........................EEEEEEEEEEEEEEE..RRRRRRRRRRRRRRRRRR..",
    "........NNNNNNNNNN..........................EEEEEEEEEEEEE....CCCCCCCCCCCCCCCC...",
    ".........NNNNNNNN............................FFFFFFFFFFF......CCCCCCCCCCCCCC....",
    "..........NNNNNN..............................FFFFFFFFF........CCCCCCCCCCCC.....",
    "...........NNNN...............................FFFFFFFFF.........CCCCCCCCCC......",
    "............NN................................FFFFFFFFF..........CCCCCCCC.......",
    "..............................................FFFFFFFFF...........CCCCCC........",
    "............SSSS..............................FFFFFFFFF.........................",
    "...........SSSSSS.............................FFFFFFFFF.........................",
    "..........SSSSSSSS.............................FFFFFFF.............OOOOOO.......",
    "..........SSSSSSSS.............................FFFFFFF............OOOOOOOO......",
    "...........SSSSSS...............................FFFFF.............OOOOOOOO......",
    "............SSSS.................................FFF...............OOOOOO.......",
    ".............SS...................................F.................OOOO........",
    "................................................................................"
];

const countries = {
    "USA": { id: "USA", name: "United Republic", color: "#3b82f6", manpower: 2000, industry: 10, ai: false },
    "EU": { id: "EU", name: "European Fed.", color: "#8b5cf6", manpower: 1500, industry: 8, ai: true, aggression: 0.4 },
    "RUS": { id: "RUS", name: "Eurasian Pact", color: "#ef4444", manpower: 2500, industry: 6, ai: true, aggression: 0.8 },
    "CHN": { id: "CHN", name: "Dragon Alliance", color: "#eab308", manpower: 3000, industry: 9, ai: true, aggression: 0.6 },
    "AFR": { id: "AFR", name: "African Union", color: "#22c55e", manpower: 1000, industry: 4, ai: true, aggression: 0.3 },
    "SAM": { id: "SAM", name: "Libertad Coalition", color: "#f97316", manpower: 1000, industry: 4, ai: true, aggression: 0.4 },
    "AUS": { id: "AUS", name: "Pacific Defense", color: "#06b6d4", manpower: 800, industry: 5, ai: true, aggression: 0.2 },
    "NEUTRAL": { id: "NEUTRAL", name: "Independent", color: "#333333", manpower: 0, industry: 0, ai: false }
};

let provinces = [];
let game = null;

// --- GENERATION ---

class Province {
    constructor(id, q, r, region) {
        this.id = id;
        this.q = q;
        this.r = r;
        this.region = region;
        this.name = `Sector ${id}`;
        this.owner = "NEUTRAL";
        this.army = 0;
        this.buildings = { factory: 0, fort: 0 };
        this.neighbors = [];
        
        // Calculate pixel center
        const size = CONFIG.hexSize;
        // Offset to center roughly in the "world" space
        this.center = {
            x: size * (Math.sqrt(3) * q + Math.sqrt(3)/2 * r) + 100,
            y: size * (3/2 * r) + 100
        };
        
        this.points = this.generateHexPoints();
    }

    generateHexPoints() {
        const points = [];
        for (let i = 0; i < 6; i++) {
            const angle_deg = 60 * i - 30;
            const angle_rad = Math.PI / 180 * angle_deg;
            points.push({
                x: this.center.x + CONFIG.hexSize * Math.cos(angle_rad),
                y: this.center.y + CONFIG.hexSize * Math.sin(angle_rad)
            });
        }
        return points;
    }
}

function generateWorldMap() {
    provinces = [];
    let idCounter = 0;
    const rows = ASCII_WORLD.length;
    const cols = ASCII_WORLD[0].length;
    
    for (let r = 0; r < rows; r++) {
        for (let q = 0; q < cols; q++) {
            const char = ASCII_WORLD[r][q];
            if (char !== '.') {
                let region = "NEUTRAL";
                let owner = "NEUTRAL";
                
                if (char === 'N') { region = "NA"; owner = "USA"; }
                else if (char === 'S') { region = "SA"; owner = "SAM"; }
                else if (char === 'E') { region = "EU"; owner = "EU"; }
                else if (char === 'F') { region = "AF"; owner = "AFR"; }
                else if (char === 'R') { region = "AS"; owner = "RUS"; }
                else if (char === 'C') { region = "AS"; owner = "CHN"; }
                else if (char === 'O') { region = "OC"; owner = "AUS"; }

                const axialQ = q - Math.floor(r/2);
                const p = new Province(idCounter++, axialQ, r, region);
                p.owner = owner;
                
                if (Math.random() < 0.15) p.owner = "NEUTRAL";

                if (p.owner !== "NEUTRAL") {
                    p.army = 50 + Math.floor(Math.random() * 100);
                    if (Math.random() < 0.3) p.buildings.factory = 1;
                } else {
                    p.army = 10 + Math.floor(Math.random() * 20);
                }
                p.name = generateCityName(region);
                provinces.push(p);
            }
        }
    }

    provinces.forEach(p => {
        const directions = [{q: 1, r: 0}, {q: 1, r: -1}, {q: 0, r: -1}, {q: -1, r: 0}, {q: -1, r: 1}, {q: 0, r: 1}];
        directions.forEach(d => {
            const neighbor = provinces.find(n => n.q === p.q + d.q && n.r === p.r + d.r);
            if (neighbor) p.neighbors.push(neighbor.id);
        });
    });
}

function generateCityName(region) {
    const prefixes = { "NA": ["New", "Fort", "San"], "EU": ["Nov", "Alt", "Burg"], "AS": ["Xin", "Dai", "Tash"], "AF": ["El", "Ben", "Dar"], "SA": ["Rio", "Santa", "Villa"], "OC": ["Port", "New", "Alice"] };
    const suffixes = { "NA": ["york", "ton", "land"], "EU": ["grad", "burg", "furt"], "AS": ["jing", "hai", "tok"], "AF": ["ro", "town", "shasa"], "SA": ["paulo", "res", "go"], "OC": ["ney", "bourne", "th"] };
    const p = prefixes[region] || ["City"];
    const s = suffixes[region] || ["ville"];
    return p[Math.floor(Math.random()*p.length)] + " " + s[Math.floor(Math.random()*s.length)];
}

// --- GAME ENGINE ---

game = {
    canvas: null,
    ctx: null,
    day: 1,
    paused: false,
    selectedProvId: null,
    attackMode: false,
    timer: null,
    playerCountry: "USA",
    camera: { x: 0, y: 0, isDragging: false, lastX: 0, lastY: 0 },

    init: function() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        
        const mapArea = document.getElementById('map-area');
        this.canvas.width = mapArea.clientWidth;
        this.canvas.height = mapArea.clientHeight;
        
        generateWorldMap();
        
        // Check for country parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const countryParam = urlParams.get('country');
        
        if (countryParam && countries[countryParam]) {
            this.startGame(countryParam);
        } else {
            this.initSetup();
        }
        
        this.render();
        
        // Input Handlers
        this.canvas.addEventListener('mousedown', this.handleMouseDown.bind(this));
        this.canvas.addEventListener('mousemove', this.handleMouseMove.bind(this));
        this.canvas.addEventListener('mouseup', this.handleMouseUp.bind(this));
        this.canvas.addEventListener('mouseleave', this.handleMouseUp.bind(this));
        
        window.addEventListener('resize', () => {
            this.canvas.width = mapArea.clientWidth;
            this.canvas.height = mapArea.clientHeight;
            this.render();
        });
        
        if (!this.playerCountry) {
            this.log("Waiting for commander selection...", "info");
        }
    },

    initSetup: function() {
        const container = document.getElementById('country-selection-list');
        container.innerHTML = "";
        
        Object.values(countries).forEach(c => {
            if (c.id === "NEUTRAL") return;
            
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.style.padding = '15px';
            btn.style.width = '200px';
            btn.style.border = `2px solid ${c.color}`;
            btn.style.textAlign = 'left';
            
            btn.innerHTML = `
                <div style="color: ${c.color}; font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">${c.name}</div>
                <div style="font-size: 0.8em; color: #aaa;">
                    Manpower: ${c.manpower}<br>
                    Industry: ${c.industry}<br>
                    Aggression: ${c.aggression || 'N/A'}
                </div>
            `;
            
            btn.onclick = () => this.startGame(c.id);
            container.appendChild(btn);
        });
    },

    startGame: function(countryId) {
        this.playerCountry = countryId;
        document.getElementById('setup-modal').style.display = 'none';
        document.getElementById('player-country-display').innerText = countries[countryId].name;
        document.getElementById('player-country-display').style.color = countries[countryId].color;
        document.getElementById('player-country-display').style.borderColor = countries[countryId].color;
        
        this.updateUI();
        this.timer = setInterval(() => this.tick(), CONFIG.tickRate);
        this.log(`Commander assigned to ${countries[countryId].name}. Operation started.`, "info");
        this.render();
    },

    switchPlayer: function(countryId) {
        this.playerCountry = countryId;
        this.selectedProvId = null;
        this.attackMode = false;
        this.log(`Command switched to ${countries[countryId].name}`, "info");
        this.updateUI();
        this.render();
    },

    tick: function() {
        if (this.paused) return;
        this.day++;
        document.getElementById('game-day').innerText = this.day;

        Object.values(countries).forEach(c => {
            if (c.id === "NEUTRAL") return;
            const myProvs = provinces.filter(p => p.owner === c.id);
            if (myProvs.length === 0) return;

            let income = 10 + (myProvs.length * 2);
            const factories = myProvs.reduce((sum, p) => sum + p.buildings.factory, 0);
            income += factories * 5;
            
            c.manpower += income;
            c.industry = factories;

            if (c.ai && c.id !== this.playerCountry) this.processAI(c, myProvs);
        });

        this.updateUI();
        this.render();
    },

    processAI: function(country, myProvs) {
        if (country.manpower > 500) {
            const borderProv = myProvs.find(p => p.neighbors.some(n => provinces.find(pr=>pr.id===n).owner !== country.id));
            if (borderProv) {
                country.manpower -= 100;
                borderProv.army += 50;
            }
        }
        myProvs.forEach(p => {
            if (p.army > 150) {
                const targets = p.neighbors.map(nid => provinces.find(pr => pr.id === nid));
                const weakTarget = targets.find(t => t.owner !== country.id && t.army < p.army * 0.6);
                if (weakTarget) this.resolveCombat(p, weakTarget);
            }
        });
    },

    togglePause: function() {
        this.paused = !this.paused;
        document.getElementById('btn-pause').innerText = this.paused ? "‚ñ∂" : "‚è∏";
    },

    // --- INPUT HANDLING (PANNING & CLICKING) ---

    handleMouseDown: function(e) {
        this.camera.isDragging = true;
        this.camera.lastX = e.clientX;
        this.camera.lastY = e.clientY;
    },

    handleMouseMove: function(e) {
        const rect = this.canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // Panning
        if (this.camera.isDragging) {
            const dx = e.clientX - this.camera.lastX;
            const dy = e.clientY - this.camera.lastY;
            this.camera.x += dx;
            this.camera.y += dy;
            this.camera.lastX = e.clientX;
            this.camera.lastY = e.clientY;
            this.render();
            return; // Don't hover while dragging
        }

        // Hover
        const worldX = mouseX - this.camera.x;
        const worldY = mouseY - this.camera.y;
        const tooltip = document.getElementById('tooltip');
        
        let hovered = null;
        let minDst = Infinity;
        
        provinces.forEach(p => {
            const dst = Math.hypot(p.center.x - worldX, p.center.y - worldY);
            if (dst < CONFIG.hexSize && dst < minDst) {
                minDst = dst;
                hovered = p;
            }
        });

        if (hovered) {
            tooltip.style.display = 'block';
            tooltip.style.left = (e.clientX + 15) + 'px';
            tooltip.style.top = (e.clientY + 15) + 'px';
            tooltip.innerHTML = `
                <strong style="color:#fff">${hovered.name}</strong><br>
                <span style="color:${countries[hovered.owner].color}">${countries[hovered.owner].name}</span><br>
                Army: ${Math.floor(hovered.army)}
            `;
        } else {
            tooltip.style.display = 'none';
        }
    },

    handleMouseUp: function(e) {
        if (!this.camera.isDragging) return;
        
        // If it was a short click (not a drag), treat as click
        // Simple check: if moved less than 5 pixels
        // For now, let's just check if we are dragging. 
        // Actually, standard behavior: if mouseup happens at same coords as mousedown, it's a click.
        // But we updated lastX/Y.
        
        // Let's use a flag "hasMoved"
        // Simplified: If we are here, we stopped dragging.
        this.camera.isDragging = false;
        
        // Check for click (if we didn't move much? Hard to track here without more state)
        // Let's just do a hit test on MouseUp. If it was a drag, the user likely moved the mouse.
        // If the user just clicked, handleMouseMove didn't move the camera much.
        
        // Better approach: Do hit test here.
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left - this.camera.x;
        const y = e.clientY - rect.top - this.camera.y;
        
        let clicked = null;
        let minDst = Infinity;
        provinces.forEach(p => {
            const dst = Math.hypot(p.center.x - x, p.center.y - y);
            if (dst < CONFIG.hexSize && dst < minDst) {
                minDst = dst;
                clicked = p;
            }
        });

        if (clicked) {
            this.handleProvinceClick(clicked);
        } else {
            // Deselect if clicked empty space (and not dragging significantly)
            // For now, just deselect
            // this.selectedProvId = null;
            // this.updateUI();
            // this.render();
        }
    },

    handleProvinceClick: function(clicked) {
        if (this.attackMode && this.selectedProvId !== null) {
            const source = provinces.find(p => p.id === this.selectedProvId);
            if (source.neighbors.includes(clicked.id)) {
                this.resolveCombat(source, clicked);
                this.attackMode = false;
                document.getElementById('map-area').style.cursor = 'grab';
            } else {
                this.log("Target out of range!", "info");
            }
        } else {
            this.selectedProvId = clicked.id;
            this.attackMode = false;
            document.getElementById('map-area').style.cursor = 'grab';
        }
        this.updateUI();
        this.render();
    },

    actions: {
        recruit: function() {
            if (!game.selectedProvId) return;
            const p = provinces.find(prov => prov.id === game.selectedProvId);
            const c = countries[game.playerCountry];
            if (p.owner !== game.playerCountry) return;
            if (c.manpower >= 100) {
                c.manpower -= 100;
                p.army += 50;
                game.updateUI();
                game.render();
                game.log(`Reinforcements arrived in ${p.name}`, "info");
            }
        },
        build: function(type) {
            if (!game.selectedProvId) return;
            const p = provinces.find(prov => prov.id === game.selectedProvId);
            const c = countries[game.playerCountry];
            if (p.owner !== game.playerCountry) return;
            const cost = type === 'factory' ? 500 : 300;
            if (c.manpower >= cost) {
                c.manpower -= cost;
                p.buildings[type]++;
                game.updateUI();
                game.render();
                game.log(`Construction complete in ${p.name}`, "info");
            }
        },
        attackMode: function() {
            if (!game.selectedProvId) return;
            const p = provinces.find(prov => prov.id === game.selectedProvId);
            if (p.owner !== game.playerCountry) return;
            game.attackMode = true;
            document.getElementById('map-area').style.cursor = 'crosshair';
            game.log("Select target province...", "info");
        },
        cheatAnnex: function() {
            if (!game.selectedProvId) return;
            const p = provinces.find(prov => prov.id === game.selectedProvId);
            if (p.owner === game.playerCountry) return;
            const oldOwner = p.owner;
            p.owner = game.playerCountry;
            p.army = 100;
            game.log(`CHEAT: Annexed ${p.name} from ${countries[oldOwner].name}`, "war");
            game.updateUI();
            game.render();
        }
    },

    resolveCombat: function(attackerProv, defenderProv) {
        if (attackerProv.army < 20) return;
        const attackForce = Math.floor(attackerProv.army * 0.8);
        attackerProv.army -= attackForce;
        let defenseMult = 1.0 + (defenderProv.buildings.fort * 0.2);
        const defenseForce = defenderProv.army * defenseMult;
        const attackRoll = attackForce * (0.8 + Math.random() * 0.4);
        const defenseRoll = defenseForce * (0.8 + Math.random() * 0.4);

        if (attackRoll > defenseRoll) {
            const remaining = Math.floor(attackForce * 0.6);
            defenderProv.owner = attackerProv.owner;
            defenderProv.army = remaining;
            defenderProv.buildings.fort = 0;
            this.log(`${countries[attackerProv.owner].name} seized ${defenderProv.name}`, "war");
        } else {
            const remaining = Math.floor(defenderProv.army * 0.7);
            defenderProv.army = remaining;
            this.log(`Assault on ${defenderProv.name} repelled`, "info");
        }
        this.render();
        this.updateUI();
    },

    log: function(msg, type) {
        const panel = document.getElementById('log-content');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerText = `D${this.day}: ${msg}`;
        panel.prepend(entry);
    },

    updateUI: function() {
        const p = countries[this.playerCountry];
        document.getElementById('player-manpower').innerText = Math.floor(p.manpower);
        document.getElementById('player-industry').innerText = p.industry;
        document.getElementById('player-provinces').innerText = provinces.filter(prov => prov.owner === this.playerCountry).length;

        const provPanel = document.getElementById('province-panel');
        if (this.selectedProvId !== null) {
            const prov = provinces.find(pr => pr.id === this.selectedProvId);
            provPanel.style.display = 'block';
            document.getElementById('prov-id').innerText = `#${prov.id}`;
            document.getElementById('prov-name').innerText = prov.name;
            
            const owner = countries[prov.owner];
            const ownerEl = document.getElementById('prov-owner');
            ownerEl.innerText = owner.name;
            ownerEl.style.color = owner.color;
            
            document.getElementById('prov-army').innerText = Math.floor(prov.army);
            document.getElementById('prov-defense').innerText = (prov.buildings.fort * 20) + "%";

            const isMine = prov.owner === this.playerCountry;
            document.getElementById('owner-actions').style.display = isMine ? 'block' : 'none';
            document.getElementById('admin-actions').style.display = !isMine ? 'block' : 'none';
        } else {
            provPanel.style.display = 'none';
        }
    },

    render: function() {
        const ctx = this.ctx;
        ctx.save();
        ctx.fillStyle = CONFIG.colors.water;
        ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

        // Apply Camera
        ctx.translate(this.camera.x, this.camera.y);

        provinces.forEach(p => {
            ctx.beginPath();
            const pts = p.points;
            ctx.moveTo(pts[0].x, pts[0].y);
            for (let i = 1; i < pts.length; i++) {
                ctx.lineTo(pts[i].x, pts[i].y);
            }
            ctx.closePath();

            if (p.id === this.selectedProvId) {
                ctx.fillStyle = CONFIG.colors.selected;
            } else {
                ctx.fillStyle = countries[p.owner].color;
            }
            ctx.fill();

            ctx.strokeStyle = CONFIG.colors.border;
            ctx.lineWidth = 1;
            if (p.id === this.selectedProvId) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
            }
            ctx.stroke();

            if (p.buildings.factory > 0) {
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.font = '10px Arial';
                ctx.fillText("‚öô", p.center.x - 5, p.center.y);
            }
            if (p.buildings.fort > 0) {
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.font = '10px Arial';
                ctx.fillText("‚ôú", p.center.x + 5, p.center.y);
            }
        });
        
        ctx.restore();
    }
};

window.onload = function() {
    game.init();
};
</script>
</body>
</html>